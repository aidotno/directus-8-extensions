<template>
	<div class="modules-analytics">
		
		<v-header 
			:title="content('title')" 
			:breadcrumb="breadcrumb" 
			icon="view_quilt" 
			settings>
		</v-header>
						
		<div class="modules-analytics-loading" v-if="loading">
			<div class="flex-item">
				<v-spinner
					v-show="loading"
					line-fg-color="var(--blue-grey-300)"
					line-bg-color="var(--blue-grey-200)"
					class="spinner">
				</v-spinner>
			</div>
		</div>
		
		<div class="modules-analytics-loading" v-else-if="loaded && !analytics.meta.total">
			<div class="flex-item w-100 animated fadeInUpSmall">
				<p class="lead" v-html="content('form.empty.message')"></p>
			</div>
		</div>
		
		<div class="modules-analytics-loaded" v-else-if="loaded">
			
			<!-- Sessions -->
			
			<div class="modules-analytics-section animated fadeIn a-delay" :data-section="kebabCase(content('charts.titles.sessions'))">
			
				<v-details :title="content('charts.titles.sessions')" type="break" open>
				
					<div class="modules-analytics-content modules-analytics-sessions animated fadeIn">
						
						<!-- Sessions - Overview -->
						
						<div class="modules-analytics-grid animated fadeIn a-delay" v-for="row in content('sections.sessions')">
							<div class="flex-item">
								<h3 class="font-accent">{{ row.headline }}</h3>
								<p class="lead">{{ row.description }}</p>
								<div class="modules-analytics-analytics">
									<p class="lead animated fadeIn font-accent">{{ details(row.property) }}</p>
								</div>
							</div>
						</div>
						
						<!-- Sessions - Charts -->
						
						<div class="modules-analytics-grid modules-analytics-chart animated fadeIn a-delay" data-chart="sessions" v-if="chart('sessions', 'Sessions')">
							<doughnut-chart :chartdata="charts.sessions" :options="charts.options"></doughnut-chart>
							<aside class="modules-analytics-overlay"><span></span></aside>
							<footer class="modules-analytics-chart">
								<p class="modules-analytics-chart">
									<span class="modules-analytics-chart-legend font-accent" v-for="legend in legends.sessions" :data-label="legend.label" :data-legend-key="legend.key" :data-tooltip="`${ legend.legend }: ${ legend.ratio }`" :style="`color: ${ legend.color };`">{{ legend.legend }}</span>
								</p>
								<p class="modules-analytics-chart">{{ content('charts.headlines.sessions') }}</p>
							</footer>
						</div>
						
					</div>
				
				</v-details>
			
			</div>	
			
			<!-- Performance and Views -->
			
			<div class="modules-analytics-section animated fadeIn a-delay" :data-section="kebabCase(content('charts.titles.performance'))">
			
				<v-details :title="content('charts.titles.performance')" type="break" open>
						
					<!-- Performance - Overview -->
				
					<div class="modules-analytics-content modules-analytics-performance animated fadeIn" v-for="(section, index) in content('sections.performance')">
						
						<div class="modules-analytics-grid animated fadeIn a-delay" v-for="(description, name) in section">
							<div class="flex-item">
								<h3 class="font-accent text-capitalize">{{ index }} &mdash; {{ name }}</h3>
								<p class="lead">{{ description }}</p>
								<div class="modules-analytics-analytics">
									<p class="lead animated fadeIn font-accent">{{ seconds( details(`data.performance.${ index }.${ name }`) ) }}</p>
								</div>
							</div>
						</div>
						
					</div>
					
					<!-- Views - Charts -->
					
					<div class="modules-analytics-content modules-analytics-views animated fadeIn">
						
						<div class="modules-analytics-grid modules-analytics-chart animated fadeIn a-delay" data-chart-type="bar" data-chart-type="bar" v-for="(row, key) in analytics.data.views" v-if="chart(`views.${ key }`, null, true)">
							<bar-chart :chartdata="charts.views[key]" :options="charts.options"></bar-chart>
							<aside class="modules-analytics-overlay"><span></span></aside>
							<footer class="modules-analytics-chart">
								<p class="modules-analytics-chart">
									<span class="modules-analytics-chart-legend font-accent" v-for="legend in legends.views[key]" :data-label="legend.label" :data-legend-key="legend.key" :data-tooltip="`${ legend.label }: ${ legend.total }`" :style="`color: ${ legend.color };`">{{ legend.legend }}</span>
								</p>
								<p class="modules-analytics-chart">{{ content(`sections.views.${ key }.description`) }}</p>
							</footer>
						</div>
						
					</div>
				
				</v-details>
			
			</div>	
			
			<!-- Locations -->
			
			<div class="modules-analytics-section animated fadeIn a-delay" :data-section="kebabCase(content('charts.titles.locations'))">
			
				<v-details :title="content('charts.titles.locations')" type="break" open>
				
					<!-- Locations - Charts -->
					
					<div class="modules-analytics-content modules-analytics-locations animated fadeIn">
						
						<div class="modules-analytics-grid modules-analytics-chart animated fadeIn a-delay" data-chart="locations" v-for="(row, key) in analytics.data.locations" v-if="chart(`locations.${ key }`)">
							<pie-chart :chartdata="charts.locations[key]" :options="charts.options"></pie-chart>
							<aside class="modules-analytics-overlay"><span></span></aside>
							<footer class="modules-analytics-chart">
								<p class="modules-analytics-chart">
									<span class="modules-analytics-chart-legend font-accent" v-for="legend in legends.locations[key]" :data-label="legend.label" :data-legend-key="legend.key" :data-tooltip="`${ legend.legend }: ${ legend.ratio }`" :style="`color: ${ legend.color };`">{{ legend.legend }}</span>
								</p>
								<p class="modules-analytics-chart">{{ content(`sections.locations.${ key }.description`) }}</p>
							</footer>
						</div>
						
					</div>
				
				</v-details>
			
			</div>	
			
			<!-- Browsers -->
			
			<div class="modules-analytics-section animated fadeIn a-delay" :data-section="kebabCase(content('charts.titles.browsers'))">
			
				<v-details :title="content('charts.titles.browsers')" type="break" open>
				
					<!-- Browsers - Charts -->
					
					<div class="modules-analytics-content modules-analytics-browsers animated fadeIn">
						
						<div class="modules-analytics-grid modules-analytics-chart animated fadeIn a-delay" data-chart="browsers" :data-chart-type="bar(row) ? 'bar' : 'pie'" v-for="(row, key) in analytics.data.browsers" v-if="chart(`browsers.${ key }`, null, bar(row))">
							<bar-chart :chartdata="charts.browsers[key]" :options="charts.options" v-if="bar(row)"></bar-chart>
							<doughnut-chart :chartdata="charts.browsers[key]" :options="charts.options" v-else></doughnut-chart>
							<aside class="modules-analytics-overlay"><span></span></aside>
							<footer class="modules-analytics-chart">
								<p class="modules-analytics-chart">
									<span class="modules-analytics-chart-legend font-accent" v-for="legend in legends.browsers[key]" :data-label="legend.label" :data-legend-key="legend.key" :data-tooltip="`${ bar(row) ? legend.label : legend.legend }: ${ bar(row) ? legend.total : legend.ratio }`" :style="`color: ${ legend.color };`">{{ legend.legend }}</span>
								</p>
								<p class="modules-analytics-chart">{{ content(`sections.browsers.${ key }.description`) }}</p>
							</footer>
						</div>
						
					</div>
				
				</v-details>
			
			</div>
			
		</div>		

		<v-info-sidebar wide itemDetail>
			<section class="info-sidebar-section">
				<h2 class="font-accent">{{ content('title') }}</h2>
				<p class="p">{{ content('description') }}</p>
			</section>
			<section class="info-sidebar-section">
				<h2 class="font-accent">{{ content('form.headline') }}</h2>
				<div class="info-sidebar-row">
					<v-input
						id="modules-analytics-start-date-input"
						type="date"
						:placeholder="content('form.startDate.placeholder')"
						:model="startDate"
						:value="startDate"
						@input="onInputStartDate">
					</v-input>
				</div>
				<div class="info-sidebar-row">
					<v-input
						id="modules-analytics-end-date-input"
						type="date"
						:placeholder="content('form.endDate.placeholder')"
						:model="endDate"
						:value="endDate"
						@input="onInputEndDate">
					</v-input>
				</div>
				<div class="info-sidebar-row">
					<v-button
						id="modules-analytics-button"
						type="button"
						@click="onSubmit"
						block>{{ content('form.submit.label') }}
					</v-button>
				</div>
			</section>	
			<nav class="info-sidebar-section info-sidebar-nav" v-if="loaded && analytics.meta.total">
				<a class="info-sidebar-nav" href="#" v-for="(row, key) in content('charts.titles')" @click.stop.prevent="onClickScroll(kebabCase(row))">{{ row }}</a>
			</nav>		
		</v-info-sidebar>
		
	</div>
</template>

<script>
	import { forEach, get, kebabCase, set, shuffle, size, startCase } from 'lodash';
	import BarChart from './charts/bar.vue';
	import DoughnutChart from './charts/doughnut.vue';
	import PieChart from './charts/pie.vue';
	
	export default {
		name: 'ModulesAnalyticsApplication',
		components: {
			'bar-chart': BarChart,
			'doughnut-chart': DoughnutChart,
			'pie-chart': PieChart
		},
		computed: {
			breadcrumb () {
				return [
					{
						name: 'Dashboard',
						path: `/${this.currentProjectKey}/ext/dashboard`
					},
					{
						name: 'Modules',
						path: `/${this.currentProjectKey}/ext/modules`
					}
				];
			},
			currentProjectKey () {
				return this.$store.state.currentProjectKey;
			},
			locale () {
				return get(this.$store.state, 'settings.values.default_locale');
			}
		},
		methods: {
			bar (input) {
				return size(input) > 4;
			},
			chart (input, label, type) {
				let $input = get(this.analytics, `data.${ input }`);
								
				if (!$input) return null;
				
				label = label || startCase(input);
				
				let colors = this.charts.colors.slice();
				
				if (size(colors) < size($input)) {
					let len = Math.ceil(size($input) / size(colors));
					
					while(len > 0) {
						colors = colors.concat(colors);
						
						len--;
					}
				}
				
				let data = {
					labels: [],
					datasets: [{
						label: label,
						backgroundColor: colors.slice(0, size($input)),
						borderWidth: 0,
						data: []
					}]
				};
				
				let keys = Object.keys($input);
				
				forEach($input, (row, key) => {
					let title = row.title || key.toUpperCase();
					let total = type === true ? row.total : row.ratio;
					
					data.labels.push(title);
					data.datasets[0].data.push(total);
					
					set(this.legends, `${ input }.${ key }`, {
						key: `${ input }.${ key }`,
						legend: title,
						color: this.charts.colors[keys.indexOf(key)],
						total: row.total,
						ratio: row.ratio,
						label: label
					});
				});
				
				set(this.charts, input, data);
								
				return data;
			},
			content (input) {
				let translation = get(this.contents, this.locale);
					translation = translation || get(this.contents, 'en-US');

				return get(translation, input);
			},
			details (input) {
				return get(this.analytics, input);
			},
			kebabCase (input) {
				return kebabCase(input);
			},
			load () {
				this.loading = true;
				let params = {};	
				
				if (this.startDate && this.endDate) {
					params = {
						start_date: this.startDate,
						end_date: this.endDate
					};
				}
											
				this.$api.api.get('/custom/analytics/application', params).then((response) => {
					
					let startDate = get(response, 'meta.start_date');
					let endDate = get(response, 'meta.end_date');
					
					this.startDate = startDate.split(' ')[0];
					this.endDate = endDate.split(' ')[0];
					
					this.loading = false;
					
					this.analytics = response;
					
					this.loaded = true;
					
				}).catch((error) => {
					
					this.error = error;
					
					this.loading = false;
				});
			},
			onClickScroll (input) {
				let $row = this.$el.querySelector(`.modules-analytics-section[data-section="${ input }"]`);
				
				if (!$row) return false;
				
				let props = $row.getBoundingClientRect();
				let top = window.scrollY + (props.y - 100);
				
				if (top < 0) top = 0;
				
				window.scrollTo({
					top: top,
					behavior: 'smooth'
				});
			},
			onInputStartDate (input) {
				this.startDate = input;
			},
			onInputEndDate (input) {
				this.endDate = input;
			},
			onSubmit (e) {
				this.loaded = false;
				
				if (this.startDate && this.endDate) this.load();
			},
			seconds (input) {
				input = parseInt(input);
				
				if (!input) return '';
								
				input = parseFloat(input / 1000).toFixed(2);
				
				return `${ input }s`;
			},
			tooltip (input) {
				let body = get(input.body, '0.lines.0');
				let title = get(input.title, '0');
				
				if (this.$overlay) this.$overlay.classList.remove('active');
				
				if (!body) return;
				
				let $legend = this.$el.querySelector(`[data-tooltip="${ body }"]`);
				let $parent = $legend.closest('.modules-analytics-grid');
				let $overlay = $parent.querySelector('.modules-analytics-overlay');
				
				let key = $legend.getAttribute('data-legend-key');
				let legend = get(this.legends, key);
				
				$overlay.innerHTML = `<span style="color: ${ legend.color };">${ legend.label }<br>${ legend.legend }: ${ legend.total } &mdash; ${ legend.ratio }</span>`;
				
				$overlay.classList.add('active');
				
				this.$overlay = $overlay;
			}
		},
		data () {
			return {
				analytics: {},
				charts: {
					options: {
						responsive: true,
						maintainAspectRatio: false,
						legend: {
							display: false
						},
						tooltips: {
							enabled: false,
							custom: this.tooltip
						}
					},
					colors: [
						"#f44336",
						"#ff9800",
						"#ff5722",
						"#ffeb3b",
						"#4caf50",
						"#2196f3",
						"#3f51b5"
					]
				},
				contents: {
					"en-US": {
						"title": "Analytics - Application",
						"subtitle": 'Analytics - Report of the Application Visitors',
						"description": 'Analytics Report of the Application Visitors',
						"form": {
							"empty": {
								"message": "Oooops! <br>No analytics data was downloaded for the start and end dates. <br>Please try adjusting the start and end dates."
							},
							"headline": "Start and End Dates",
							"startDate": {
								"placeholder": "Analytics Start Date"
							},
							"endDate": {
								"placeholder": "Analytics End Date"
							},
							"submit": {
								"label": "Update Analytics"
							}
						},
						"charts": {
							"titles": {
								"sessions": "Visitors and Sessions",
								"performance": "Performance and Views",
								"locations": "Locations",
								"browsers": "Browsers and Devices"
							},
							"headlines": {
								"sessions": "Visitors via Website vs Downloaded App"
							}
						},
						"sections": {
							"performance": {
								"loaded": {
									"average": "The average # seconds it takes to download and render the App",
									"min": "The minimum # seconds it takes to download and render the App",
									"max": "The maximum # seconds it takes to download and render the App"
								},
								"downloaded": {
									"average": "The average # seconds it takes to download the App",
									"min": "The minimum # seconds it takes to download the App",
									"max": "The maximum # seconds it takes to download the App"
								},
								"rendered": {
									"average": "The average # seconds it takes to render the App",
									"min": "The minimum # seconds it takes to load the App",
									"max": "The maximum # seconds it takes to load the App"
								}
							},
							"views": {
								"viewsize": {
									"headline": "View Sizes",
									"description": "The width and height of the browser or the app container"
								},
								"screensize": {
									"headline": "Screen Sizes",
									"description": "The width and height of the device used to view the app"
								},
								"page": {
									"headline": "Pages",
									"description": "The most and least viewed pages or sections of the app"
								}
							},
							"sessions": {
								"sessions": {
									"headline": "Sessions",
									"description": "# times the App was loaded",
									"property": "meta.total"
								},
								"visitors": {
									"headline": "Unique Visitors",
									"description": "# unique visitors to the App",
									"property": "meta.visitors"
								},
								"website": {
									"headline": "Websites",
									"description": "# times the App was loaded in a Browser",
									"property": "data.sessions.website.total"
								},
								"pwa": {
									"headline": "PWAs",
									"description": "# times the App was loaded as an App",
									"property": "data.sessions.pwa.total"
								}
							},
							"locations": {
								"time_zone": {
									"headline": "Time Zones",
									"description": "The time zones of all the visitors to the app"
								},
								"country": {
									"headline": "Countries",
									"description": "The countries of all the visitors to the app"
								},
								"region": {
									"headline": "Regions",
									"description": "The regions, states, or provinces of all the visitors to the app"
								}
							},
							"browsers": {
								"name": {
									"headline": "Browsers",
									"description": "The browsers with which visitors view the website or app"
								},
								"engine_name": {
									"headline": "Browser Engines",
									"description": "The browser engines with which visitors view the website or app"
								},
								"device_vendor": {
									"headline": "Device Manufacturers",
									"description": "The manufacturers of the devices with which visitors view the website or app"
								},
								"device_model": {
									"headline": "Device",
									"description": "The devices with which visitors view the website or app"
								},
								"device_type": {
									"headline": "Device Type",
									"description": "The type of devices with which visitors view the website or app"
								},
								"operating_system_name": {
									"headline": "Operating System",
									"description": "The operating systems of the devices with which visitors view the website or app"
								}
							}
						}
					}						
				},
				endDate: null,
				startDate: null,
				legends: {},
				loaded: false,
				loading: false
			};
		},
		metaInfo() {
			return {
				title: this.content('subtitle')
			};
		},
		mounted () {
			this.load();
		}
	}
</script>

<style lang="scss">
	.modules-analytics {
		padding: var(--page-padding);
		position: relative;
		
		.modules-analytics-section {
			position: relative;
		}
		
		.modules-analytics-form {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			grid-gap: 1rem;
			
			.modules-analytics-column {
				button {
					height: 52px;
				}
			}
		}
		
		.modules-analytics-content {
			display: grid;
			grid-template-columns: repeat(4, 1fr);
			grid-gap: 1rem;
			
			& + .modules-analytics-content {
				padding-top: 1rem;
			}
			
			&.modules-analytics-browsers,
			&.modules-analytics-views {
				grid-template-columns: repeat(2, 1fr);
			}
			
			&.modules-analytics-locations,
			&.modules-analytics-performance {
				grid-template-columns: repeat(3, 1fr);
			}
			
			.modules-analytics-grid {
				background-color: rgba(white, 0.1);
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				position: relative;
				overflow: hidden;
				animation-duration: 600ms;
				padding: 1.5rem 1rem;
				
				&[data-chart="sessions"] {
					grid-column: 3/5 !important;
					grid-row: 1/3 !important;
				}
				
				&[data-chart-type="bar"] {
					max-height: 60vh;
					
					&:nth-child(1) {
						grid-column: 1/3 !important;
					}
				}
				
				&.modules-analytics-chart {
					padding-bottom: 6rem !important;
					
					&[data-chart-type="bar"] {
						padding-bottom: 3rem !important;
					}
					
					& > div {
						max-height: 100%;
						max-width: 100%;
					}
					
					&[data-chart-type="bar"] {
						& > div {
							min-height: 100%;
							min-width: 100%;
						}
						
						footer.modules-analytics-chart {
							span.modules-analytics-chart-legend {
								display: none !important;
							}
						}
					}
					
					aside.modules-analytics-overlay {
						position: absolute;
						top: 0;
						left: 0;
						bottom: 0;
						right: 0;
						background-color: rgba(#303030, 0.8);
						display: flex;
						align-items: center;
						justify-content: center;
						text-align: center;
						pointer-events: none;
						opacity: 0;
						transition: opacity 500ms ease;
						
						&.active {
							opacity: 1;
						}
						
						span {
							animation: fadeIn 650ms ease;	
							font-family: var(--main-font-accent);	
							line-height: 2rem;		
							text-transform: capitalize;			
							
							&:after {
								content: '%';
							}
						}
					}
					
					footer.modules-analytics-chart {
						position: absolute;
						bottom: 0;
						width: 100%;
						padding: 0.75rem;
						text-align: center;
						color: var(--blue-grey-500);
						font-size: 12px;
						font-weight: 500;
						
						span.modules-analytics-chart-legend {
							color: var(--main-primary-color);
							display: inline-block;
							font-weight: 500;
							padding: 0.5rem 1rem;
							text-transform: capitalize;
						}
					}
				}
				
				.flex-item {
					flex-grow: 1;
					text-align: center;
					color: var(--main-primary-color);
					padding: 1rem;
					
					h3 {
						font-size: 1.5rem;
						margin: 0 auto 0.3rem auto;
					}
					
					.lead {
						font-size: 1rem;
					}
					
					.icon {
						display: flex;
						align-items: center;
						justify-content: center;
						width: 60px;
						height: 60px;
						background: rgba(white, 0.1);
						margin: 0 auto 2rem auto;
						border-radius: 50%;						
					}
					
					.modules-analytics-analytics {
						position: relative;
						padding: 1rem;
						
						p.lead {
							color: rgba(white, 0.3);
							font-size: 2.5rem !important;
							font-weight: 300 !important;
						}
					}
				}
			}
		}
		.v-spinner {
			margin: auto;
		}
		.icon {
			i {
				font-size: 24px;
			    font-family: Material Icons;
			    font-weight: 400;
			    font-style: normal;
			    display: inline-block;
			    line-height: 1;
			    text-transform: none;
			    letter-spacing: normal;
			    word-wrap: normal;
			    white-space: nowrap;
			    font-feature-settings: "liga";
			    vertical-align: middle;
			}
		}	
	}
	.modules-analytics-loading {
		display: flex;
		align-items: center;
		justify-content: center;
		min-height: calc(100vh - 350px);
		
		.w-100 {
			flex-grow: 1;
		}
	}
</style>